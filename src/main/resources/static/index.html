<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ER Scanner</title>

    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>

    <style>
        body {
          margin:0;
          font-family:Segoe UI, Arial, sans-serif;
          background:#f4f6f9;
        }

        header {
          padding:15px 25px;
          background:#1f2937;
          color:white;
          font-size:20px;
          font-weight:600;
        }

        #controls {
          padding:15px 25px;
          background:white;
          border-bottom:1px solid #ddd;
        }

        button {
          padding:8px 14px;
          border:none;
          background:#2563eb;
          color:white;
          border-radius:4px;
          cursor:pointer;
          margin-right:10px;
        }

        button:hover {
          background:#1e40af;
        }

        #diagramContainer {
          padding:30px;
          overflow:auto;
        }

        .mermaid {
          background:white;
          padding:20px;
          border-radius:8px;
          box-shadow:0 2px 8px rgba(0,0,0,0.08);
        }
    </style>
</head>
<body>

<header>
    ER Scanner â€“ Database Visualization
</header>

<div id="controls">
    <button onclick="scanAndRender()">Scan Database</button>
    <button onclick="downloadMermaid()">Download ER Text</button>
</div>

<div id="diagramContainer">
    <div class="mermaid" id="diagram">
        Click "Scan Database" to generate ER diagram.
    </div>
</div>

<script>

    mermaid.initialize({
      startOnLoad:false,
      theme:"default",
      securityLevel:"loose",
      er: {
        useMaxWidth:true
      }
    });

    async function scanAndRender() {

      document.getElementById("diagram").innerHTML = "Scanning database...";

      await fetch('/schema/scan', { method:'POST' });

      const res = await fetch('/schema/er-mermaid');
      const text = await res.text();

      const element = document.getElementById("diagram");
      element.innerHTML = text;

      mermaid.init(undefined, element);
    }

    async function downloadMermaid() {

      const res = await fetch('/schema/er-mermaid');
      const text = await res.text();

      const blob = new Blob([text], { type: "text/plain" });
      const url = window.URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "er-diagram.mmd";
      a.click();

      window.URL.revokeObjectURL(url);
    }

</script>

</body>
</html>