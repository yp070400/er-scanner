<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ER Scanner (Chunked Mermaid)</title>

    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>

    <style>
        body {
          margin:0;
          font-family:Segoe UI, sans-serif;
          background:#f4f6f9;
        }

        header {
          padding:15px 25px;
          background:#1f2937;
          color:white;
          font-size:20px;
        }

        #controls {
          padding:15px 25px;
          background:white;
          border-bottom:1px solid #ddd;
        }

        select, button {
          padding:8px 12px;
          margin-right:10px;
        }

        #diagramContainer {
          padding:30px;
          overflow:auto;
        }

        .mermaid {
          background:white;
          padding:20px;
          border-radius:8px;
          box-shadow:0 2px 8px rgba(0,0,0,0.08);
        }
    </style>
</head>
<body>

<header>ER Scanner â€“ Chunked Mermaid View</header>

<div id="controls">
    <button onclick="scan()">Scan Database</button>
    <select id="chunkSelect" onchange="renderChunk()"></select>
</div>

<div id="diagramContainer">
    <div class="mermaid" id="diagram">
        Click Scan Database to generate ER diagram.
    </div>
</div>

<script>

    mermaid.initialize({
      startOnLoad:false,
      theme:"default",
      securityLevel:"loose"
    });

    let chunks = {};

    async function scan() {

      document.getElementById("diagram").innerHTML = "Scanning...";

      await fetch('/schema/scan', { method:'POST' });

      const res = await fetch('/schema/er-mermaid-chunks');
      chunks = await res.json();

      const select = document.getElementById("chunkSelect");
      select.innerHTML = "";

      Object.keys(chunks).forEach(key => {
        const option = document.createElement("option");
        option.value = key;
        option.text = key;
        select.appendChild(option);
      });

      renderChunk();
    }

    function renderChunk() {

      const select = document.getElementById("chunkSelect");
      const selected = select.value;

      if (!selected) return;

      const element = document.getElementById("diagram");
      element.innerHTML = chunks[selected];

      mermaid.init(undefined, element);
    }

</script>

</body>
</html>